PUSH //some changes to vanilla code to make everything work
ORG $1D24C //check for canto, modified to just check for cantoing bit set
SHORT 0x7b18 0x2102 0x4001 0x2902 0xd020 0x2140 0x4008 0x46c0 0x2800 

ORG $18754 //this used to set state to "turn ended"
SHORT 0x46C0
ORG $1D264 //this used to be part of the "check if already cantoing"
SHORT 0x2000
ORG $1D26C //this used to be part of the "check for this turn's action"
SHORT 0x2110
ORG $323A0 //making dance not clear the galeforce flag
SHORT 0xFFBD
SHORT 0xFFFF
ORG $39B98 //this sets 00040000 to the status bitfield thing for some reason on non-player units
SHORT 0x46C0
POP

	/* Post-battle calculation loop*/

PUSH

    ORG $1D308 //hook just before the check for misc event
    jumpToHack(PostCombatLoop)
    
POP

PostCombatLoop:
    #incbin "PostBattleCalcLoop.dmp"
    POIN PostCombatActions

PostCombatActions: 
    #ifdef UNLOCK_STAFF_ON_CHESTS
        POIN PostCombat_Unlock
    #endif
    POIN Lifetaker
    #ifdef HAX_MAP_AURA_FX
        POIN PostBattleSupports 
    #endif
    POIN Canto WitchRewarp //this works i guess
    #ifdef GAIDEN_MAGIC_INSTALLED
        POIN PostCombat_SpellClear
    #endif
    WORD 0 //Terminator

    PROTECT $1D308 $1D314
ALIGN 4

Canto:
#incbin "canto.dmp"
POIN prMovGetter
ALIGN 4

Lifetaker:
#incbin "Lifetaker.dmp"
POIN LifetakerEvent
ALIGN 4

LifetakerEvent:
CAM1 0xFFFF
RESUMM 0xFFFF
STAL 90
NoFade
ENDA
ALIGN 4

UpheavalEvent:
	CAM1 0xFFFF
	EARTHQUAKE_START 0x100
	STAL 60
	SOUN 0xCB //woosh
	STAL 0x16
	SOUN 0xCB //woosh
	STAL 0x16
	SOUN 0xD5 //map kill
	STAL 0x16
	EARTHQUAKE_END
	NoFade
	ENDA
ALIGN 4

	/* Post-action calculation loop*/
	
#ifdef ESCAPE_ARRIVE_INSTALLED
	#include "PostActionCalcLoop.lyn.event"
	PostActionCalcFunctions: // Parameters: r0 = character struct. Immediately after "Turn ended" bit in the turn status bitfield is set.
	POIN FinalEscapeThing
	WORD 0

	PROTECT $1879A $187B4
#endif
