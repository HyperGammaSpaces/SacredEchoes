//Invoke functionality
#include "MultiSummons.lyn.event"
#include "EnemySummon.lyn.event"
PUSH
    
#ifdef ItemEffectRevamp
    //This will also set it for Mogall Divide since it's based on effect
    IER_setItemEffect(IER_FX_Invoke, InvokeStaff_GetUsability, PUNull, InvokeStaff_GetTargetList, InvokeStaff_GetUseEffect)
#else
    
    //Old Hammerne slot
    ORG $288E0
	POIN InvokeStaff_GetUsability
	ORG $2FCC0
	POIN InvokeStaff_GetUseEffect
    ORG $28EBC
    POIN InvokeStaff_GetTargetList

	//Mogall ability stuff
	ORG $289B4
	POIN InvokeStaff_GetUsability
	ORG $2FD94
	POIN InvokeStaff_GetUseEffect
	ORG $28F90
	POIN InvokeStaff_GetTargetList

#endif
    
    ORG $59DAFC //at the end of the Battle proc, we're cutting into the Arena proc a bit but who cares
    PROC_CALL_ROUTINE(Summoner_Clear|1)
    PROC_LABEL(1)
    PROC_CALL_ROUTINE_2($328D0|1)
    PROC_CALL_ROUTINE($3286C|1)
    PROC_YIELD
    PROC_END
    
    ORG $32554
    replaceWithHack(EnemySummonAction)
    
    ORG $2900C
    InvokeStaff_GetTargetList:
		SHORT $1C28
		BL($2951C)          //no targeting needed
		B(EndGetTargetList)
	
	//Change usability routine for Invoke
	ORG $28B2C	//Invoke
    InvokeStaff_GetUsability:
		New_Use(InvokeStaff_RangeSetup)
        
    ORG $2FEB4
	InvokeStaff_GetUseEffect:
		SHORT $1C30
		BL(Invoke_Use_Effect)
		B($2FF76)
        
    ORG $2F2B4
    Invoke_Use_Effect:
		#incbin "Invoke_Use_Effect.dmp"
		
	//Specify as non-healing staff
	ORG $725C4
		POIN $726A4
    ORG $7266C //and same for Conjure
        POIN $726A4
    ORG $72698 //and same for Mogall Divide
        POIN $726A4
		
	//Switch Summon proc to DKSummon proc
	ORG $7B794
		WORD $089A33C0
		
	//Change DKSummon to use Summon Rework
	ORG $7AD1C
	DoInvoke_Main_Jump:
		replaceWithHack(DoInvoke_Main)
	ORG $7B1C0
	HandleSummonBatch_Jump:
		replaceWithHack(NewHandleSummonBatch)
		
	ORG $9A33CC
		POIN StartMultiSummon|1 //7afd0
	ORG $9A33EC
		POIN DoInvoke_Multi|1 //7b2b4
	ORG $9A341C
		POIN DoInvoke_Multi|1 //7b2b4
	ORG $9A344C
		POIN DoInvoke_Multi|1 //7b2b4
	ORG $9A347C
		POIN DoInvoke_Multi|1 //7b2b4
	
	//Bring summons closer
	ORG $7B23E
	BYTE $01
	ORG $7B25A
	BYTE $01
	ORG $7B27A
	BYTE $01
	ORG $7B29E
	BYTE $01

POP

Invoke_Usability:
#incbin "InvokeUsability.dmp"
ALIGN 4

InvokeStaff_RangeSetup:
	rfItemRangeSetup(Invoke_Usability+1,Item_TTRange)
ALIGN 4

SummonTable:
BYTE Silque 					PlayerUnitSummon	DreadFighter 	12
BYTE Tatiana 					PlayerUnitSummon	PegasusKnight 	12
BYTE Genny 						PlayerUnitSummon	Soldier 		12
BYTE CantorBoss_Celica5 		Terror_Revenant		Revenant		1
BYTE CantorBoss_Bonewalkers		Terror_Bonewalker	Bonewalker		2
BYTE Mikhail					Terror_Gargoyle		Gargoyle		4
BYTE Garcia						Terror_Gargoyle		Gargoyle		4
BYTE Cantor_Gargs				Terror_Gargoyle		Gargoyle		4
BYTE Dolth						Terror_Necrodragon	Necrodragon		6
BYTE Nuibaba						Terror_Gorgon	Gorgon		2
BYTE Jedah_Ch4					Terror_Mogall		Mogall			0
BYTE Terror_Mogall				Terror_Mogall		Mogall			0
BYTE Terror_ArchMogall			Terror_ArchMogall	ArchMogall		0
BYTE MogallBoss					Terror_Mogall		Mogall			0
BYTE 0							0					0				0

ALIGN 4
SummonerCleanupEvent:
    LABEL 0x2A02
    BEQ 0x2A03 0xD 0x0
        //Pop from queue into slot B
        SLOTS_SETFROMQUEUE 0xB
        SET_SOMETHING (-2)
        DISA_IF (-2)
        CHECK_ENEMIES
        BNE 0x2A02 0xC 0x0
            ENUT Local_EnemyRouted
            GOTO 0x2A02
    LABEL 0x2A03
    NoFade
    ENDA

//General phantom fixes to work with expanded summon table
#include "Phantom/PhantomRework.event"

//Echoes-specific stuff
#include "Phantom/EchoesPhantoms.event"
