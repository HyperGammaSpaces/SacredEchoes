//Invoke functionality
#include "MultiSummons.lyn.event"
PUSH
	/*
	//should be in main staff targeting rework
	ORG InvokeStaffP4Jump
		SHORT $1C28
		BL(InvokeOnSelect)
		B(P4Ladder_End)
	*/
	
	//Mogall ability stuff
	ORG $289B4
	POIN $28B2C
	ORG $2FD94
	POIN $2FEB4
	ORG $28F90
	POIN $2900C
	ORG $72698
	POIN $726A4
	
	//Change usability routine for Invoke
	ORG $28B2C	//Invoke
		New_Use(InvokeStaff_RangeSetup)
		
	ORG $299BA; BL(Invoke_Jump)
	
	//08029a08 HammerneTargetSelection_OnChange - nop out 29a20
	ORG $29A1C
		WORD 0
		WORD 0
	
	//08029a2c HammerneTargetSelection_OnInit - just nop this out
	ORG $29A2E
		SHORT 0
		SHORT 0
	
	//59D3B8
	//08029944 HammerneTargetSelection_OnSelect
	
	//080299b8 SetupHammerneUseSelection
	
	//2f2b4 - replace with InvokeOnSelect
	//2900E - change to a BL to 2951c
	
	ORG $29944
		InvokeOnSelect:
		#incbin "InvokeOnSelect.dmp"
	
	ORG $2F2B4
		SHORT $B570 $BC70 $BC01 $4700 //does nothing
	
	ORG $262A8
	Invoke_Jump:
		SHORT 0xB500 0x1C22 0x4902
		BL($D18C4)
		SHORT 0xBC01 0x4700 0x0
		POIN InvokeStaff_RangeSetup|1
	
	//Specify Invoke, Rewarp, Entrap and Expel as non-healing staves
	//Expel
	ORG $72598
		POIN $726A4
	//Entrap
	ORG $725B4
		POIN $726A4
	//Invoke
	ORG $725C4
		POIN $726A4
	//Rewarp
	ORG $725CC
		POIN $726A4
		
	//Switch Summon proc to DKSummon proc
	ORG $7B794
		WORD $089A33C0
		
	//Change DKSummon to use Summon Rework
	ORG $7AD1C
	DoInvoke_Main_Jump:
		replaceWithHack(DoInvoke_Main)
	ORG $7B1C0
	HandleSummonBatch_Jump:
		replaceWithHack(NewHandleSummonBatch)
		
	ORG $9A33CC
		POIN StartMultiSummon|1 //7afd0
	ORG $9A33EC
		POIN DoInvoke_Multi|1 //7b2b4
	ORG $9A341C
		POIN DoInvoke_Multi|1 //7b2b4
	ORG $9A344C
		POIN DoInvoke_Multi|1 //7b2b4
	ORG $9A347C
		POIN DoInvoke_Multi|1 //7b2b4
	
	//Bring summons closer
	ORG $7B23E
	BYTE $01
	ORG $7B25A
	BYTE $01
	ORG $7B27A
	BYTE $01
	ORG $7B29E
	BYTE $01

POP

InvokeStaff_RangeSetup:
	SHORT 0xB500 0x4903		//load usability routine
	SHORT 0x4803 0x6800		//Load unitID into r0
	BL(Item_TTRange)		//Check tiles in range
	SHORT 0xBC08 0x4718		//pop and exit
	POIN (Invoke_Usability | 1)		//Usability routine
	WORD 0x03004E50			//unit pointer
ALIGN 4

Invoke_Usability:
#incbin "InvokeUsability.dmp"
ALIGN 4





SummonTable:
BYTE Silque 			PlayerUnitSummon 	DreadFighter 	0
BYTE Tatiana 			PlayerUnitSummon 	PegasusKnight 	0
BYTE Genny 				PlayerUnitSummon 	Soldier 		0
BYTE Mikhail			Terror_Gargoyle		Gargoyle		0
BYTE Garcia				Terror_Gargoyle		Gargoyle		0
BYTE Cantor_Gargs		Terror_Gargoyle		Gargoyle		0
BYTE Dolth				Terror_Necrodragon	Necrodragon		0
BYTE Jedah_Ch4			Terror_Mogall		Mogall			0
BYTE Terror_Mogall		Terror_Mogall		Mogall			0
BYTE Terror_ArchMogall		Terror_ArchMogall		ArchMogall			0
BYTE MogallBoss			Terror_Mogall		Mogall			0
BYTE CantorBoss 		Terror_Revenant 	Revenant 		0
BYTE CantorBoss_Bonewalkers Terror_Bonewalker Bonewalker 0
BYTE 0 			0 		0 				0

//General phantom fixes
PUSH	
	//Change class check for unitID check on KillUnitIfNoHP
	ORG $1840C
	SHORT $6810 $7900 $283F

	//Don't draw portrait on item select menu if unit is generic
	ORG $22BE8
	SHORT $6808 $88C0 $2800
	
	//Remove hardcoded checks for phantom class - use 0x3F as summon unit ID
	ORG $18EDA
	SHORT $6810 $7900 $283F
	ORG $23046
	SHORT $6811 $7909 $1C04 $293F
	ORG $232C8
	SHORT $6810 $7900 $283F
	ORG $23F74
	SHORT $6800 $7900 $283F
	ORG $23FDE
	SHORT $6810 $7900 $283F
	ORG $2403A
	SHORT $6810 $7900 $283F
	ORG $24096
	SHORT $6810 $7900 $283F
	ORG $2523A
	SHORT $6810 $7900 $283F
	ORG $25242
	SHORT $6823 $7918 $283F
	ORG $2C524
	SHORT $6818 $7900 $283F
	ORG $3122A
	SHORT $6808 $7900 $283F
	
	//Update Trade command to block summoned units
	ORG $22F38
	jumpToHack(NewTradeUsability)
	ORG $25518
	jumpToHack(NewGiveToEligibility)
	
	//don't let summons rescue/take
	ORG UM_Rescue_Definition+0xC
	//ORG $59CD34
	POIN NewRescueMenuUsability|1
	//ORG $59CD7C
	ORG UM_Take_Definition+0xC
	POIN NewTakeUsability|1
POP

NewRescueMenuUsability:
#incbin "Phantom/NewRescueUsability.dmp"
ALIGN 4

NewTakeUsability:
#incbin "Phantom/NewTakeUsability.dmp"
ALIGN 4

NewGiveToEligibility:
#incbin "Phantom/GivenToUsability.dmp"
ALIGN 4

NewTradeUsability:
#incbin "Phantom/TradeUsability.dmp"
ALIGN 4





//Phantom stuff for Echoes phantoms
PUSH

	//Replace BerserkPhase with PhantomPhase
    ORG $155C0
	POIN PhantomPhase_Proc
	ORG $59a2ec
	POIN PhantomPhase_Proc
	ORG $59a394
	POIN PhantomPhase_Proc
	ORG $59a3bc
	POIN PhantomPhase_Proc
	ORG $59a424
	POIN PhantomPhase_Proc
	
	//phantom map palette (replaces link arena 4)
	ORG $59EEC0
	#incbin "Phantom/59EEA0_phantom_map_pal.pal.bin"
	
	//Allow NPCs to drop
	ORG $32942
	BYTE $80
	
	//1e098 - r0 is unit ptr, r1 is item short, r2 is proc
	//hook at 1e09c
	ORG $1E09C
	jumpToHack(SendPhantomItemsToConvoy)

	//Use with unit/class flag 0x00100000 Disable Unit Select to make phantoms unselectable. (breaks tents but lol)
	ORG $1D570
	jumpToHack(HandleSpriteHover)
	
	ORG $27a88
	jumpToHack(HandlePhantomSpriteHover)
	
	ORG $27EA8
	BL(StatscreenHoverLadder)

	ORG $90DC4
	//fix phantom palette on unit menu
	SHORT $E005
	
	ORG $784A2
	BL(StatscreenHoverLadder) //forces hover anims to check "use light rune palette"
	
	ORG $871B4
    StatscreenHoverLadder:
	replaceWithHack(HandleStatscreenHover)
	//UnitMenuLadder:
	//replaceWithHack(HandlePhantomUnitMenu)
POP

PhantomPhase_Proc: //based on 5A7F30

	PROC_SET_NAME($080D80A0)
	PROC_CALL_ROUTINE(PhantomPhase_Init+1) 
	PROC_YIELD
	PROC_CALL_ROUTINE($39778+1) //CpPhase_Cleanup
	PROC_END

PhantomOrder_Proc: //based on 5A7F74

	PROC_SET_NAME($080D80B8)
	PROC_CALL_ROUTINE(PhantomOrder_Init+1)
	PROC_LOOP_ROUTINE($39ABC+1)
	PROC_END

#include "Phantom/PhantomPhase.lyn.event"
