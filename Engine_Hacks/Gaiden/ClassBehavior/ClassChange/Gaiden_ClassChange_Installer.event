
#include "Extensions/Hack Installation.txt"

#define AutopromoTableEntry(UnitID, LevelEligible, EligibleClass) "BYTE UnitID LevelEligible EligibleClass 0"

PUSH

	ORG $2BD50
	#include "BaseStatPromotions.lyn.event"
	ALIGN 4
    AlmPromotionFlagLink:
    WORD gAlmPromoted
	
	ORG $CCCD6 		//check whether game has been beaten and third promo option can be shown
	BYTE $01		//force true
	
	ORG $CCD70 //terrain of branch promotion screen
	BYTE $39
	
	ORG $CC6FC
	POIN NewAutopromoTable
	
	ORG $8ADF76
	BYTE Cavalier Cavalier_F Paladin Paladin_F Soldier Knight Knight_F Thief Thief_F Mercenary Myrmidon DreadFighter 0x16 Archer Archer_F Sniper Sniper_F WyvernRider WyvernRider_F Mage Mage_F Villager Villager_F Fighter Brigand Pirate Priest PegasusKnight Cleric $0
	
	ORG $2F6A0
	SHORT $2000 $2000    //no weapon display at promotion: promotion screen
	
	ORG $CD0EC				//no weapon display at promotion: branch screen
	SHORT $2000 ($2000|MilasPromotionBlessing)
	
	ORG $CCE14				//pushing out the class descriptions a bit
	BYTE $5A $33
	
	ORG $CDD1E				//pushing out the class descriptions from $38 to $5A
	BYTE $5A $30
	
	ORG $CCF74 				//expanding VRAM to make room for class descriptions
	BYTE $80 $00
	
	ORG $CC750				//turn off autopromote for lv10 villagers
	SHORT $46C0
	
	ORG $CCE60
	jumpToHack(NewBranchPromoEligibility)
	
	ORG $CDB54
	jumpToHack(NewBranchPromoOptionSelect)

	ORG $B129EC
	POIN NewPromoMenuCommandDefs

POP

#define PromoMenuCommand(optionNumber) "WORD 0; SHORT 0; SHORT $06DC; BYTE 0 optionNumber 0 0; POIN (0x4F448+1); POIN (0xCDCC4+1); POIN (0xCDB34+1); WORD 0; POIN (0xCDD00+1); WORD 0"
#define PromoMenuCommandEnd "WORD 0 0 0 0 0 0 0 0 0"

ALIGN 4
NewPromoMenuCommandDefs:
pNewPromoMenuCommands:
	PromoMenuCommand(0)
	PromoMenuCommand(1)
	PromoMenuCommand(2)
	PromoMenuCommand(3)
	PromoMenuCommand(4)
PromoMenuCommandEnd

/*
Add 1 PromoMenuCommand macro for each promotion you want selectable
if you have some custom ASM to check whether an option is usable, make a copy of the PromoMenuCommand macro and change the POIN (0x0804F448+1) to point to (your ASM org +1)
*/

ALIGN 4
NewAutopromoTable:
	AutopromoTableEntry(Gray, 5, Villager)
	AutopromoTableEntry(Tobin, 5, Villager)
	AutopromoTableEntry(Kliff, 5, Villager)
	AutopromoTableEntry(Faye, 5, Villager_F)
	AutopromoTableEntry(Atlas, 5, Villager)

ALIGN 4
NewBranchPromoEligibility:
#incbin "NewBranchPromoEligibility.dmp"

ALIGN 4
NewBranchPromoOptionSelect:
#incbin "NewBranchPromoOptionSelect.dmp"

ALIGN 4
IsUnitEligibleToPromote:
#incbin "IsUnitEligibleToPromote.dmp"
POIN PromotionLevelTable

ALIGN 4
PromotionLevelTable:
BYTE Cavalier 			0x07
BYTE Cavalier_F 		0x07
BYTE Paladin 			0x0A
BYTE Paladin_F 			0x0A
BYTE Soldier 			0x07
BYTE Knight 			0x0A
BYTE Knight_F 			0x0A
BYTE Thief 				0x0C
BYTE Thief_F 			0x0C
BYTE Mercenary 			0x07
BYTE Mercenary_F 		0x07
BYTE Myrmidon 			0x0A
BYTE Myrmidon_F 		0x0A
BYTE DreadFighter 		0x0A
BYTE DreadFighter_F 	0x0A
BYTE Archer 			0x07
BYTE Archer_F 			0x07
BYTE Sniper 			0x0A
BYTE Sniper_F 			0x0A
BYTE Mage 				0x0C
BYTE Mage_F 			0x0E
BYTE Priestess 			0x0C
BYTE Villager 			0x03
BYTE Villager_F 		0x03
BYTE Woodcutter 		0x07
BYTE Axeman 			0x0A
BYTE PegasusKnight 		0x0C
BYTE Cleric 			0x0C
BYTE $FF $FF //terminator
ALIGN 4

UpdatePromoInventory:
#include "UpdateInventory.lyn.event"
PitchforkReplaceWeaponList:
BYTE BaseSword BaseLance BaseAxe BaseBow Fire Nosferatu 0 0

#include "MilaStatues/MilaStatuesInstaller.event"
#include "SplitPromoItems/SplitPromoItems.event"
